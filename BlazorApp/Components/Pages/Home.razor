@page "/"
@rendermode InteractiveServer

@using System.Text.Json

@inject IConfiguration Configuration
@inject HttpClient Http

<PageTitle>Current weather</PageTitle>

<h1>Current weather</h1>

<MudText Typo="Typo.h6">
    Type any city
</MudText>
<div style="width: 350px;">
    <div style="display: flex; align-items: center;">
        <MudTextField @bind-Value="searchQuery" 
                      Label="Search for a city" 
                      Variant="Variant.Outlined" 
                      Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Style="width: 200px; flex-shrink: 0;"
                      OnKeyDown="OnKeyDown" />
        
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   OnClick="async () => await FetchLocations(searchQuery)"
                   Style="height: 56px; min-width: 56px;">
            Search</MudButton>
    </div>
</div>

@code {
    private string searchQuery = "";
    private string httpRequestDetails = "";
    private int httpResponseCode = 0;

    private List<Location> locations = new();
    private List<string> enteredTexts = new();

    async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            enteredTexts.Add(searchQuery);
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                await FetchLocations(searchQuery);
            }
        }
    }


    private async Task OnSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? "";
        if (!string.IsNullOrWhiteSpace(searchQuery) && searchQuery.Length >= 3)
        {
            await FetchLocations(searchQuery);
        }
        else
        {
            locations = new();
            httpRequestDetails = "";
            httpResponseCode = 0;
        }
    }

    private async Task FetchLocations(string query)
    {
        var apiKey = Configuration["AppSettings:AppId"];
        if (string.IsNullOrEmpty(apiKey))
        {
            Console.WriteLine("Error: API key is missing. Please configure AppSettings:AppId in appsettings.json");
            // Handle missing API key
            return;
        }

        var url = $"http://api.openweathermap.org/geo/1.0/direct?q={Uri.EscapeDataString(query)}&limit=5&appid={apiKey}";
        httpRequestDetails = $"GET {url}";
        try
        {
            var response = await Http.GetAsync(url);
            httpResponseCode = (int)response.StatusCode;
            
            if (response.IsSuccessStatusCode)
            {
                var jsonContent = await response.Content.ReadAsStringAsync();
                var content = JsonSerializer.Deserialize<List<Location>>(jsonContent);
                locations = content ?? new();
                httpRequestDetails += $"\nStatus: {httpResponseCode} {response.StatusCode}\nLocations found: {locations.Count}";
            }
            else
            {
                locations = new();
                httpRequestDetails += $"\nStatus: {httpResponseCode} {response.StatusCode}\nError: Request failed";
            }
        }
        catch (Exception ex)
        {
            // Handle error
            locations = new();
            httpResponseCode = 0;
            httpRequestDetails += $"\nStatus: Error\nMessage: {ex.Message}";
        }
    }

    public class Location
    {
        public string? Name { get; set; }
        public double Lat { get; set; }
        public double Lon { get; set; }
        public string? Country { get; set; }
    }
}

<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">
    @if (httpResponseCode == 200 && locations.Count > 0)
    {
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h6">@searchQuery HTTP Request Details</MudText>
                    <MudText Typo="Typo.body2" Style="white-space: pre-wrap; font-family: monospace; margin-top: 12px;">
                        Response Code: @httpResponseCode
                        @httpRequestDetails
                    </MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="8">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h6">Locations Found</MudText>
                    <MudList T="Location">
                        @foreach (var location in locations)
                        {
                            <MudListItem T="Location">
                                <MudText Typo="Typo.body2">
                                    <strong>@location.Name</strong>, @location.Country
                                </MudText>
                                <MudText Typo="Typo.caption">
                                    Latitude: @location.Lat | Longitude: @location.Lon
                                </MudText>
                            </MudListItem>
                        }
                    </MudList>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
    else if (httpResponseCode != 0)
    {
        <MudPaper Elevation="2" Class="pa-4 mt-4" Style="background-color: #ffebee;">
            <MudText Typo="Typo.h6" Color="Color.Error">The location you are looking for is not found</MudText>
            <MudText Typo="Typo.body2" Class="mt-2">Response Code: @httpResponseCode</MudText>
        </MudPaper>
    }
</MudContainer>